syntax = "proto3";

option go_package = "cbt-test-mini-project/gen/proto/base";
package base;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// ========================================
// ENUMS
// ========================================

enum JawabanOption {
    JAWABAN_INVALID = 0;
    A = 1;
    B = 2;
    C = 3;
    D = 4;
}

enum TestStatus {
    STATUS_INVALID = 0;
    ONGOING = 1;
    COMPLETED = 2;
    TIMEOUT = 3;
}

// Question type for mixed sessions
enum QuestionType {
    QUESTION_TYPE_INVALID = 0;
    MULTIPLE_CHOICE = 1;
    DRAG_DROP = 2;
}

// Drag-drop question subtype
enum DragDropType {
    DRAG_TYPE_INVALID = 0;
    ORDERING = 1;   // Sequence/order items
    MATCHING = 2;   // Match items to categories
}

// ========================================
// BASE SERVICE
// ========================================

service Base {
    rpc HealthCheck(google.protobuf.Empty) returns (MessageStatusResponse) {};
}

// ========================================
// AUTH SERVICE (Added for JWT Authentication)
// ========================================

service AuthService {
    rpc Login(LoginRequest) returns (LoginResponse) {};
    rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {};
    rpc GetProfile(google.protobuf.Empty) returns (UserResponse) {};
    // User Management (Admin Only)
    rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {};
    rpc GetUser(GetUserRequest) returns (UserResponse) {};
    rpc UpdateUser(UpdateUserRequest) returns (UserResponse) {};
    rpc DeleteUser(DeleteUserRequest) returns (MessageStatusResponse) {};
    rpc CreateUser(CreateUserRequest) returns (UserResponse) {};
}

// ========================================
// MATA PELAJARAN SERVICE
// ========================================

service MataPelajaranService {
    rpc CreateMataPelajaran(CreateMataPelajaranRequest) returns (MataPelajaranResponse) {};
    rpc GetMataPelajaran(GetMataPelajaranRequest) returns (MataPelajaranResponse) {};
    rpc UpdateMataPelajaran(UpdateMataPelajaranRequest) returns (MataPelajaranResponse) {};
    rpc DeleteMataPelajaran(DeleteMataPelajaranRequest) returns (MessageStatusResponse) {};
    rpc ListMataPelajaran(google.protobuf.Empty) returns (ListMataPelajaranResponse) {};
}

// ========================================
// MATERI SERVICE
// ========================================

service MateriService {
    rpc CreateMateri(CreateMateriRequest) returns (MateriResponse) {};
    rpc GetMateri(GetMateriRequest) returns (MateriResponse) {};
    rpc UpdateMateri(UpdateMateriRequest) returns (MateriResponse) {};
    rpc DeleteMateri(DeleteMateriRequest) returns (MessageStatusResponse) {};
    rpc ListMateri(ListMateriRequest) returns (ListMateriResponse) {};
}

// ========================================
// TINGKAT SERVICE
// ========================================

service TingkatService {
    rpc CreateTingkat(CreateTingkatRequest) returns (TingkatResponse) {};
    rpc GetTingkat(GetTingkatRequest) returns (TingkatResponse) {};
    rpc UpdateTingkat(UpdateTingkatRequest) returns (TingkatResponse) {};
    rpc DeleteTingkat(DeleteTingkatRequest) returns (MessageStatusResponse) {};
    rpc ListTingkat(google.protobuf.Empty) returns (ListTingkatResponse) {};
}

// ========================================
// SOAL SERVICE (ADMIN)
// ========================================

service SoalService {
    rpc CreateSoal(CreateSoalRequest) returns (SoalResponse) {};
    rpc GetSoal(GetSoalRequest) returns (SoalResponse) {};
    rpc UpdateSoal(UpdateSoalRequest) returns (SoalResponse) {};
    rpc DeleteSoal(DeleteSoalRequest) returns (MessageStatusResponse) {};
    rpc ListSoal(ListSoalRequest) returns (ListSoalResponse) {};
    rpc UploadImageToSoal(UploadImageToSoalRequest) returns (UploadImageResponse) {};
    rpc DeleteImageFromSoal(DeleteImageFromSoalRequest) returns (MessageStatusResponse) {};
    rpc UpdateImageInSoal(UpdateImageInSoalRequest) returns (MessageStatusResponse) {};
    rpc GetQuestionCountsByTopic(google.protobuf.Empty) returns (QuestionCountsResponse) {};
}

// ========================================
// SOAL DRAG DROP SERVICE (ADMIN)
// ========================================

service SoalDragDropService {
    rpc CreateSoalDragDrop(CreateSoalDragDropRequest) returns (SoalDragDropResponse) {};
    rpc GetSoalDragDrop(GetSoalDragDropRequest) returns (SoalDragDropResponse) {};
    rpc UpdateSoalDragDrop(UpdateSoalDragDropRequest) returns (SoalDragDropResponse) {};
    rpc DeleteSoalDragDrop(DeleteSoalDragDropRequest) returns (MessageStatusResponse) {};
    rpc ListSoalDragDrop(ListSoalDragDropRequest) returns (ListSoalDragDropResponse) {};
}

// ========================================
// TEST SESSION SERVICE (STUDENT)
// ========================================

service TestSessionService {
    // Session management
    rpc CreateTestSession(CreateTestSessionRequest) returns (TestSessionResponse) {};
    rpc GetTestSession(GetTestSessionRequest) returns (TestSessionResponse) {};

    // Test execution (NEW - critical!)
    rpc GetTestQuestions(GetTestQuestionsRequest) returns (TestQuestionsResponse) {};
    rpc SubmitAnswer(SubmitAnswerRequest) returns (SubmitAnswerResponse) {};
    rpc SubmitDragDropAnswer(SubmitDragDropAnswerRequest) returns (SubmitDragDropAnswerResponse) {};
    rpc ClearAnswer(ClearAnswerRequest) returns (ClearAnswerResponse) {};
    rpc CompleteSession(CompleteSessionRequest) returns (TestSessionResponse) {};

    // Results & review
    rpc GetTestResult(GetTestResultRequest) returns (TestResultResponse) {};

    // Admin queries
    rpc ListTestSessions(ListTestSessionsRequest) returns (ListTestSessionsResponse) {};
}

// ========================================
// HISTORY SERVICE (NEW - Replaced Analytics)
// ========================================

service HistoryService {
    rpc GetStudentHistory(StudentHistoryRequest) returns (StudentHistoryResponse) {};  // For logged-in student
    rpc GetHistoryDetail(GetHistoryDetailRequest) returns (HistoryDetailResponse) {};
}

// ========================================
// COMMON MESSAGES
// ========================================

message MessageStatusResponse {
    string message = 1;
    string status = 2;
}

message PaginationRequest {
    int32 page = 1;
    int32 page_size = 2;
}

message PaginationResponse {
    int32 total_count = 1;
    int32 total_pages = 2;
    int32 current_page = 3;
    int32 page_size = 4;
}

// ========================================
// AUTH MESSAGES (Added for JWT Authentication)
// ========================================

enum UserRole {
    ROLE_INVALID = 0;
    SISWA = 1;
    ADMIN = 2;
}

message User {
    int32 id = 1;
    string email = 2;
    string nama = 3;
    UserRole role = 4;
    bool is_active = 5;
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp updated_at = 7;
    string password_hash = 8;
}

message LoginRequest {
    string email = 1;
    string password = 2;
}

message LoginResponse {
    string token = 1;
    string refresh_token = 2;
    User user = 3;
    google.protobuf.Timestamp expires_at = 4;
    bool success = 5;
    string message = 6;
}

message UserResponse {
    User user = 1;
    bool success = 2;
    string message = 3;
}

message ListUsersRequest {
    UserRole role = 1;  // Optional filter
    int32 status_filter = 2;  // 0=all, 1=active only, 2=inactive only
    PaginationRequest pagination = 3;
}

message ListUsersResponse {
    repeated User users = 1;
    PaginationResponse pagination = 2;
    bool success = 3;
    string message = 4;
    int32 total = 5;
}

message GetUserRequest {
    int32 id = 1;
}

message CreateUserRequest {
    string email = 1;
    string password = 2;
    string nama = 3;
    UserRole role = 4;
}

message UpdateUserRequest {
    int32 id = 1;
    string email = 2;
    string nama = 3;
    UserRole role = 4;
    bool is_active = 5;
}

message DeleteUserRequest {
    int32 id = 1;
}

message RefreshTokenRequest {
    string refresh_token = 1;
}

message RefreshTokenResponse {
    string token = 1;
    string refresh_token = 2;
    google.protobuf.Timestamp expires_at = 3;
    bool success = 4;
    string message = 5;
}

// ========================================
// MATA PELAJARAN MESSAGES
// ========================================

message MataPelajaran {
    int32 id = 1;
    string nama = 2;
}

message CreateMataPelajaranRequest {
    string nama = 1;
}

message GetMataPelajaranRequest {
    int32 id = 1;
}

message UpdateMataPelajaranRequest {
    int32 id = 1;
    string nama = 2;
}

message DeleteMataPelajaranRequest {
    int32 id = 1;
}

message MataPelajaranResponse {
    MataPelajaran mata_pelajaran = 1;
}

message ListMataPelajaranResponse {
    repeated MataPelajaran mata_pelajaran = 1;
}

// ========================================
// MATERI MESSAGES
// ========================================

message Materi {
    int32 id = 1;
    MataPelajaran mata_pelajaran = 2;  // Nested, bukan hanya ID
    Tingkat tingkat = 3;
    string nama = 4;
    bool is_active = 5;
    int32 default_durasi_menit = 6;
    int32 default_jumlah_soal = 7;
    int32 jumlah_soal_real = 8;  // Actual question count from database
}

message CreateMateriRequest {
    int32 id_mata_pelajaran = 1;
    int32 id_tingkat = 2;
    string nama = 3;
    bool is_active = 4;
    int32 default_durasi_menit = 5;
    int32 default_jumlah_soal = 6;
}

message GetMateriRequest {
    int32 id = 1;
}

message UpdateMateriRequest {
    int32 id = 1;
    int32 id_mata_pelajaran = 2;
    int32 id_tingkat = 3;
    string nama = 4;
    bool is_active = 5;
    int32 default_durasi_menit = 6;
    int32 default_jumlah_soal = 7;
}

message DeleteMateriRequest {
    int32 id = 1;
}

message MateriResponse {
    Materi materi = 1;
}

message ListMateriRequest {
    int32 id_mata_pelajaran = 1;
    int32 id_tingkat = 2;
    PaginationRequest pagination = 3;
}

message ListMateriResponse {
    repeated Materi materi = 1;
    PaginationResponse pagination = 2;
}

// ========================================
// TINGKAT MESSAGES
// ========================================

message Tingkat {
    int32 id = 1;
    string nama = 2;
}

message CreateTingkatRequest {
    string nama = 1;
}

message GetTingkatRequest {
    int32 id = 1;
}

message UpdateTingkatRequest {
    int32 id = 1;
    string nama = 2;
}

message DeleteTingkatRequest {
    int32 id = 1;
}

message TingkatResponse {
    Tingkat tingkat = 1;
}

message ListTingkatResponse {
    repeated Tingkat tingkat = 1;
}

// ========================================
// SOAL MESSAGES
// ========================================

// Image metadata for soal
message SoalGambar {
    int32 id = 1;
    string nama_file = 2;
    string file_path = 3;
    int32 file_size = 4;
    string mime_type = 5;
    int32 urutan = 6;
    string keterangan = 7;
    string cloud_id = 8;
    string public_id = 9;
    google.protobuf.Timestamp created_at = 10;
}

// Full soal with answer (for admin/teacher only)
message SoalFull {
    int32 id = 1;
    Materi materi = 2;
    string pertanyaan = 3;
    string opsi_a = 4;
    string opsi_b = 5;
    string opsi_c = 6;
    string opsi_d = 7;
    JawabanOption jawaban_benar = 8;
    string pembahasan = 9;
    repeated SoalGambar gambar = 10;
}

// Soal for student (no answer exposed)
message SoalForStudent {
    int32 id = 1;
    int32 nomor_urut = 2;  // Question number in test
    string pertanyaan = 3;
    string opsi_a = 4;
    string opsi_b = 5;
    string opsi_c = 6;
    string opsi_d = 7;
    JawabanOption jawaban_dipilih = 8;  // If already answered
    bool is_answered = 9;
    Materi materi = 10;
    repeated SoalGambar gambar = 11;
}

message CreateSoalRequest {
    int32 id_materi = 1;
    int32 id_tingkat = 2;
    string pertanyaan = 3;
    string opsi_a = 4;
    string opsi_b = 5;
    string opsi_c = 6;
    string opsi_d = 7;
    JawabanOption jawaban_benar = 8;
    string pembahasan = 9;
    repeated bytes image_bytes = 10;
}

message GetSoalRequest {
    int32 id = 1;
}

message UpdateSoalRequest {
    int32 id = 1;
    int32 id_materi = 2;
    int32 id_tingkat = 3;
    string pertanyaan = 4;
    string opsi_a = 5;
    string opsi_b = 6;
    string opsi_c = 7;
    string opsi_d = 8;
    JawabanOption jawaban_benar = 9;
    string pembahasan = 10;
    repeated bytes image_bytes = 11;
}

message DeleteSoalRequest {
    int32 id = 1;
}

message SoalResponse {
    SoalFull soal = 1;
}

message ListSoalRequest {
    int32 id_materi = 1;
    int32 id_tingkat = 2;
    int32 id_mata_pelajaran = 3;
    PaginationRequest pagination = 4;
}

message ListSoalResponse {
    repeated SoalFull soal = 1;
    PaginationResponse pagination = 2;
}

message UploadImageToSoalRequest {
    int32 id_soal = 1;
    bytes image_bytes = 2;
    string nama_file = 3;
    int32 urutan = 4;
    string keterangan = 5;
}

message UploadImageResponse {
    SoalGambar gambar = 1;
}

message DeleteImageFromSoalRequest {
    int32 id_gambar = 1;
}

message UpdateImageInSoalRequest {
    int32 id_gambar = 1;
    int32 urutan = 2;
    string keterangan = 3;
}

// ========================================
// SOAL DRAG DROP MESSAGES
// ========================================

// Draggable item
message DragItem {
    int32 id = 1;
    string label = 2;
    string image_url = 3;
    int32 urutan = 4;
}

// Drop zone/slot
message DragSlot {
    int32 id = 1;
    string label = 2;
    string image_url = 3;
    int32 urutan = 4;
}

// Correct answer mapping (item -> slot)
message DragCorrectAnswer {
    int32 item_id = 1;
    int32 slot_id = 2;
}

// Correct answer by urutan (for create/update requests)
message DragCorrectAnswerByUrutan {
    int32 item_urutan = 1;
    int32 slot_urutan = 2;
}

// Full drag-drop question (admin view with answers)
message SoalDragDropFull {
    int32 id = 1;
    Materi materi = 2;
    string pertanyaan = 3;
    DragDropType drag_type = 4;
    repeated DragItem items = 5;
    repeated DragSlot slots = 6;
    repeated DragCorrectAnswer correct_answers = 7;
    string pembahasan = 8;
    bool is_active = 9;
    google.protobuf.Timestamp created_at = 10;
    google.protobuf.Timestamp updated_at = 11;
}

// Drag-drop for student (no correct answers exposed)
message SoalDragDropForStudent {
    int32 id = 1;
    int32 nomor_urut = 2;
    string pertanyaan = 3;
    DragDropType drag_type = 4;
    repeated DragItem items = 5;
    repeated DragSlot slots = 6;
    Materi materi = 7;
    map<int32, int32> user_answer = 8;  // item_id -> slot_id
    bool is_answered = 9;
}

// Unified question for mixed test sessions
message QuestionForStudent {
    int32 nomor_urut = 1;
    QuestionType question_type = 2;
    Materi materi = 3;
    bool is_answered = 4;

    // Multiple choice fields (only populated when question_type = MULTIPLE_CHOICE)
    int32 mc_id = 5;
    string mc_pertanyaan = 6;
    string mc_opsi_a = 7;
    string mc_opsi_b = 8;
    string mc_opsi_c = 9;
    string mc_opsi_d = 10;
    JawabanOption mc_jawaban_dipilih = 11;
    repeated SoalGambar mc_gambar = 12;

    // Drag-drop fields (only populated when question_type = DRAG_DROP)
    int32 dd_id = 13;
    string dd_pertanyaan = 14;
    DragDropType dd_drag_type = 15;
    repeated DragItem dd_items = 16;
    repeated DragSlot dd_slots = 17;
    map<int32, int32> dd_user_answer = 18;  // item_id -> slot_id
}

message CreateSoalDragDropRequest {
    int32 id_materi = 1;
    int32 id_tingkat = 2;
    string pertanyaan = 3;
    DragDropType drag_type = 4;
    repeated DragItem items = 5;
    repeated DragSlot slots = 6;
    repeated DragCorrectAnswerByUrutan correct_answers = 7;
    string pembahasan = 8;
}

message GetSoalDragDropRequest {
    int32 id = 1;
}

message UpdateSoalDragDropRequest {
    int32 id = 1;
    int32 id_materi = 2;
    int32 id_tingkat = 3;
    string pertanyaan = 4;
    DragDropType drag_type = 5;
    repeated DragItem items = 6;
    repeated DragSlot slots = 7;
    repeated DragCorrectAnswerByUrutan correct_answers = 8;
    string pembahasan = 9;
    bool is_active = 10;
}

message DeleteSoalDragDropRequest {
    int32 id = 1;
}

message SoalDragDropResponse {
    SoalDragDropFull soal = 1;
}

message ListSoalDragDropRequest {
    int32 id_materi = 1;
    int32 id_tingkat = 2;
    PaginationRequest pagination = 3;
}

message ListSoalDragDropResponse {
    repeated SoalDragDropFull soal = 1;
    PaginationResponse pagination = 2;
}

// ========================================
// TEST SESSION MESSAGES
// ========================================

message TestSession {
    int32 id = 1;
    string session_token = 2;
    User user = 3;  // From JWT, not input
    string nama_peserta = 4;  // Participant's name
    Tingkat tingkat = 5;
    MataPelajaran mata_pelajaran = 6;  // Nested object
    google.protobuf.Timestamp waktu_mulai = 7;
    google.protobuf.Timestamp waktu_selesai = 8;
    google.protobuf.Timestamp batas_waktu = 9;  // ADDED
    int32 durasi_menit = 10;
    double nilai_akhir = 11;
    int32 jumlah_benar = 12;
    int32 total_soal = 13;
    TestStatus status = 14;
}

message CreateTestSessionRequest {
    int32 id_tingkat = 1;
    int32 id_mata_pelajaran = 2;
    int32 durasi_menit = 3;
    int32 jumlah_soal = 4;  // ADDED - critical!
}

message GetTestSessionRequest {
    string session_token = 1;
}

message TestSessionResponse {
    TestSession test_session = 1;
}

message ListTestSessionsRequest {
    int32 id_tingkat = 1;
    int32 id_mata_pelajaran = 2;
    TestStatus status = 3;
    PaginationRequest pagination = 4;
}

message ListTestSessionsResponse {
    repeated TestSession test_sessions = 1;
    PaginationResponse pagination = 2;
}

// ========================================
// TEST EXECUTION MESSAGES (NEW)
// ========================================

message GetTestQuestionsRequest {
    string session_token = 1;
    int32 nomor_urut = 2;  // Question number to fetch (1-20, etc.)
}

message TestQuestionsResponse {
    string session_token = 1;
    repeated QuestionForStudent questions = 2;  // ALL questions for the session (mixed types)
    int32 total_soal = 3;
    int32 current_nomor_urut = 4;
    int32 dijawab_count = 5;
    repeated bool is_answered_status = 6;  // Bool array for all questions (sidebar status)
    google.protobuf.Timestamp batas_waktu = 7;
}

message SubmitAnswerRequest {
    string session_token = 1;
    int32 nomor_urut = 2;
    JawabanOption jawaban_dipilih = 3;
}

message SubmitAnswerResponse {
    string session_token = 1;
    int32 nomor_urut = 2;
    JawabanOption jawaban_dipilih = 3;
    bool is_correct = 4;  // Immediate feedback
    google.protobuf.Timestamp dijawab_pada = 5;
}

message SubmitDragDropAnswerRequest {
    string session_token = 1;
    int32 nomor_urut = 2;
    map<int32, int32> answer = 3;  // For ORDERING: position->itemId, For MATCHING: slotId->itemId
}

message SubmitDragDropAnswerResponse {
    string session_token = 1;
    int32 nomor_urut = 2;
    map<int32, int32> answer = 3;
    bool is_correct = 4;
    google.protobuf.Timestamp dijawab_pada = 5;
}

message ClearAnswerRequest {
    string session_token = 1;
    int32 nomor_urut = 2;
}

message ClearAnswerResponse {
    string session_token = 1;
    int32 nomor_urut = 2;
    google.protobuf.Timestamp dibatalkan_pada = 3;
}

message CompleteSessionRequest {
    string session_token = 1;
}

// ========================================
// TEST RESULT MESSAGES (NEW)
// ========================================

message GetTestResultRequest {
    string session_token = 1;
}

message JawabanDetail {
    int32 nomor_urut = 1;
    string pertanyaan = 2;
    string opsi_a = 3;
    string opsi_b = 4;
    string opsi_c = 5;
    string opsi_d = 6;
    JawabanOption jawaban_dipilih = 7;
    JawabanOption jawaban_benar = 8;
    bool is_correct = 9;
    bool is_answered = 10;
    string pembahasan = 11;
    repeated SoalGambar gambar = 12;
    QuestionType question_type = 13;
    DragDropType drag_type = 14;
    repeated DragItem items = 15;
    repeated DragSlot slots = 16;
    map<int32, int32> user_drag_answer = 17;
    map<int32, int32> correct_drag_answer = 18;
}

message TestResultResponse {
    TestSession session_info = 1;
    repeated JawabanDetail detail_jawaban = 2;
    repeated Tingkat tingkat = 3;
}

// ========================================
// HISTORY MESSAGES (NEW - Replaced Analytics)
// ========================================

message StudentHistoryRequest {
    int32 user_id = 1;  // From JWT, not input
    int32 tingkatan = 2;  // Optional filter
    int32 id_mata_pelajaran = 3;  // Optional filter
    PaginationRequest pagination = 4;
}

message HistorySummary {
    int32 id = 1;
    string session_token = 2;
    MataPelajaran mata_pelajaran = 3;
    Tingkat tingkat = 4;
    google.protobuf.Timestamp waktu_mulai = 5;
    google.protobuf.Timestamp waktu_selesai = 6;
    int32 durasi_pengerjaan_detik = 7;  // Actual time spent
    double nilai_akhir = 8;
    int32 jumlah_benar = 9;
    int32 total_soal = 10;
    TestStatus status = 11;
    string nama_peserta = 12;
}

message StudentHistoryResponse {
    repeated HistorySummary history = 1;
    PaginationResponse pagination = 2;

    // Aggregate stats
    double rata_rata_nilai = 3;
    int32 total_test_completed = 4;
    User user = 5;
    int32 tingkatan = 6;
}

message ListStudentHistoriesRequest {
    int32 user_id = 1;  // Optional: filter by specific student
    int32 tingkatan = 2;  // Optional filter
    int32 id_mata_pelajaran = 3;  // Optional filter
    PaginationRequest pagination = 4;
}

message ListStudentHistoriesResponse {
    repeated StudentHistoryWithUser history_per_student = 1;
    PaginationResponse pagination = 2;
}

message StudentHistoryWithUser {
    User user = 1;
    repeated HistorySummary history = 2;
    double rata_rata_nilai = 3;
    int32 total_test_completed = 4;
}

message GetHistoryDetailRequest {
    string session_token = 1;
}

message HistoryDetailResponse {
    TestSession session_info = 1;
    repeated JawabanDetail detail_jawaban = 2;

    // Breakdown per materi
    repeated MateriBreakdown breakdown_materi = 3;
}

message MateriBreakdown {
    string nama_materi = 1;
    int32 jumlah_soal = 2;
    int32 jumlah_benar = 3;
    double persentase_benar = 4;
}

message QuestionCountsResponse {
    repeated TopicCount counts = 1;
}

message TopicCount {
    int32 topic_id = 1;
    int32 count = 2;
}